(function(){"use strict";async function wt(a){const{lat:s,lon:e,diameter:t,mass:i,velocity:o,fireball:n,shockwave:l,craterKm:c,tsunamiRadius:u}=a;console.log(`Starting enhanced casualty estimation for impact at ${s}, ${e}`),console.log("Impact effects data:",{fireball:n,shockwave:l,craterKm:c,tsunamiRadius:u});let r=await at(s,e);(!r||r<=0)&&(console.warn("Population estimation failed, using minimal default"),r=50),console.log(`Base population estimate: ${r}`);const m=.5*i*o*o,M=m/4184e12;console.log(`Energy calculation: mass=${i}kg, velocity=${o}m/s, energyJ=${m.toExponential(2)}, energyMt=${M.toFixed(3)}`);const h=await xt({lat:s,lon:e,basePop:r,diameter:t,energyMt:M,fireball:n,shockwave:l,craterKm:c,tsunamiRadius:u}),w=Pt(t);return console.log(`Enhanced casualty estimation complete: ${h.totalDeaths} deaths from multiple effects`),{deaths:h.totalDeaths,population:h.totalPopulation,fatalityRate:h.totalPopulation>0?h.totalDeaths/h.totalPopulation:0,energyJ:m,energyMt:M,diameter:t,yearsBetweenImpacts:w,effects:h.effects}}async function xt(a){const{lat:s,lon:e,basePop:t,diameter:i,energyMt:o,fireball:n,shockwave:l,craterKm:c,tsunamiRadius:u}=a;console.log("Calculating multi-effect casualties...");let r={crater:{deaths:0,population:0,radius:0},fireball:{deaths:0,population:0,radius:0},shockwave:{deaths:0,population:0,radius:0},seismic:{deaths:0,population:0,radius:0},tsunami:{deaths:0,population:0,radius:0}};if(c&&c>0){const d=c*1e3/2,g=await _(s,e,d);r.crater={deaths:Math.round(g*.99),population:g,radius:d},console.log(`Crater effect: ${r.crater.deaths} deaths in ${d}m radius`)}if(n&&n.Rfireball>0){const d=await gt(s,e,n,r.crater.radius);r.fireball=d,console.log(`Fireball effect: ${r.fireball.deaths} deaths from thermal radiation`)}if(l&&l.R>0){const d=await yt(s,e,l,Math.max(r.crater.radius,r.fireball.radius));r.shockwave=d,console.log(`Shockwave effect: ${r.shockwave.deaths} deaths from overpressure`)}const m=Math.max(1e4,c?c*1e3*5:i*10),M=await zt(s,e,o,m,Math.max(r.crater.radius,r.fireball.radius,r.shockwave.radius));if(r.seismic=M,console.log(`Seismic effect: ${r.seismic.deaths} deaths from earthquakes`),u&&u>0){const d=await bt(s,e,u);r.tsunami=d,console.log(`Tsunami effect: ${r.tsunami.deaths} deaths from flooding`)}const h=Math.max(r.crater.population,r.fireball.population,r.shockwave.population,r.seismic.population,r.tsunami.population,t),w=Math.max(r.crater.deaths,r.fireball.deaths,r.shockwave.deaths,r.seismic.deaths,r.tsunami.deaths),x=Math.round((r.crater.deaths+r.fireball.deaths+r.shockwave.deaths+r.seismic.deaths+r.tsunami.deaths-w)*.3);return{totalDeaths:Math.min(h,w+x),totalPopulation:h,effects:r}}async function gt(a,s,e,t=0){const{Rfireball:i,R3b:o,R2b:n}=e;let l=0,c=0;const u=Math.max(i,o,n);if(u>t){if(o>t){const r=await _(a,s,o,t),m=Math.round(r*.95);l+=m,c+=r}if(n>o){const r=await _(a,s,n,Math.max(o,t)),m=Math.round(r*.25);l+=m,c+=r}if(i>n){const r=await _(a,s,i,Math.max(n,t)),m=Math.round(r*.05);l+=m,c+=r}}return{deaths:l,population:c,radius:u}}async function yt(a,s,e,t=0){let i=0,o=0,n=0;if(e.R&&e.windspeed&&Math.pow(e.windspeed/1.2,2)>100&&e.R*1e3>t){const c=await _(a,s,e.R*1e3,t),u=Math.round(c*.8);i+=u,o+=c,n=Math.max(n,e.R*1e3)}if(e.R1&&e.windspeed1&&Math.pow(e.windspeed1/1.2,2)>20&&e.R1*1e3>n){const c=await _(a,s,e.R1*1e3,Math.max(n,t)),u=Math.round(c*.4);i+=u,o+=c,n=Math.max(n,e.R1*1e3)}if(e.R2&&e.windspeed2&&Math.pow(e.windspeed2/1.2,2)>5&&e.R2*1e3>n){const c=await _(a,s,e.R2*1e3,Math.max(n,t)),u=Math.round(c*.1);i+=u,o+=c,n=Math.max(n,e.R2*1e3)}return{deaths:i,population:o,radius:n}}async function zt(a,s,e,t,i=0){if(t<=i)return{deaths:0,population:0,radius:0};const o=await _(a,s,t,i);let n=0;return e>1e3?n=.02:e>100?n=.01:e>10?n=.005:n=.001,{deaths:Math.round(o*n),population:o,radius:t}}async function bt(a,s,e){const t=await vt(a,s,e);return{deaths:Math.round(t*.2),population:t,radius:e}}async function _(a,s,e,t=0){const i=await at(a,s),n=Math.PI*(Math.pow(e,2)-Math.pow(t,2))/1e6,c=i/1*Math.exp(-e/5e4);return Math.round(n*c)}async function vt(a,s,e){const t=await _(a,s,e);return Math.round(t*.3)}function Pt(a){if(a<10){const e=1e3*Math.pow(a,-2.7);return Math.max(1,1/e)}else if(a<100){const e=.1*Math.pow(a/10,-2.5);return Math.max(100,1/e)}else if(a<1e3){const e=.001*Math.pow(a/100,-2.3);return Math.max(1e4,1/e)}else{const e=1e-6*Math.pow(a/1e3,-2);return Math.max(1e6,1/e)}}async function at(a,s){try{console.log(`Fetching population data for lat: ${a}, lon: ${s}`);const e=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${a}&lon=${s}&zoom=10`,t=await fetch(e,{headers:{"User-Agent":"meteor-estimator/1.0 (contact:you@example.com)"},mode:"cors"});if(!t.ok)return console.error(`Nominatim API error: ${t.status}`),await H(a,s);const i=await t.json();if(console.log("Nominatim response:",i),i?.extratags?.population){const o=parseInt(i.extratags.population);if(!isNaN(o))return console.log(`Found population in extratags: ${o}`),o}if(i?.extratags?.wikidata){const o=i.extratags.wikidata;console.log(`Trying Wikidata for QID: ${o}`);const n=await Rt(o);if(n)return console.log(`Found population in Wikidata: ${n}`),n}return await H(a,s,i)}catch(e){return console.error("Population fetch error:",e),await H(a)}}async function H(a,s,e=null){let t=50,i=1;if(e){const n=e.display_name||"",l=e.place_type||e.type||"";if(console.log(`Estimating population for place: ${n}, type: ${l}`),n.includes("City")||l==="city")t=2500,i=10;else if(n.includes("Town")||l==="town")t=1e3,i=5;else if(n.includes("Village")||l==="village")t=300,i=2;else if(n.includes("Ocean")||n.includes("Sea"))t=0;else if(n.includes("Desert")||n.includes("Mountain"))t=5;else{const c=Math.abs(a);c<30?t=150:c<50?t=100:t=10}}const o=Math.round(i*t);return console.log(`Estimated population: ${o} (density: ${t}/km², area: ${i}km²)`),o}async function Rt(a){try{const s=`https://www.wikidata.org/w/api.php?action=wbgetclaims&property=P1082&entity=${a}&format=json&origin=*`,e=await fetch(s,{mode:"cors"});if(!e.ok)return console.error(`Wikidata API error: ${e.status}`),null;const t=await e.json();console.log("Wikidata response:",t);const i=t?.claims?.P1082;if(i&&i.length>0){let o=i[0];for(const l of i)if(l.qualifiers?.P585){const c=l.qualifiers.P585[0].datavalue.value.time,u=o.qualifiers?.P585?.[0]?.datavalue?.value?.time;(!u||c>u)&&(o=l)}const n=o.mainsnak.datavalue?.value?.amount;if(n){const l=parseInt(n.replace(/^\+/,""));if(!isNaN(l))return l}}return null}catch(s){return console.error("Wikidata fetch error:",s),null}}self.addEventListener("message",async a=>{const s=a.data;if(!s||s.cmd!=="run")return;const e=s.params;try{const t=$t(e);let i=null;if(t.meta.impacted&&!t.meta.disintegrated&&!t.meta.earlyTermination){const o=t.meta.impactLocation;if(o&&o.lat&&o.lon){const n={lat:o.lat,lon:o.lon,diameter:e.diameter,mass:t.meta.finalMass,velocity:t.meta.residualEkJ>0?Math.sqrt(2*t.meta.residualEkJ/t.meta.finalMass):Math.sqrt(2*t.meta.initialEkJ/t.meta.initialMass),density:e.density,angleDeg:e.angleDeg,energyJ:t.meta.residualEkJ,fireball:t.fireball,shockwave:t.shockwave,craterKm:t.crater_km,tsunamiRadius:t.tsunami_m};console.log("[worker] Calling enhanced casualty estimation with effects data:",{fireball:t.fireball,shockwave:t.shockwave,craterKm:t.crater_km,tsunamiRadius:t.tsunami_m}),i=await wt(n)}}console.log("[worker] About to send fireball:",t.fireball),self.postMessage({type:"simResult",xs:t.xs,lats:t.lats,lons:t.lons,alts:t.alts,vs:t.vs,wzs:t.wzs,times:t.times,ms:t.ms,crater_km:t.crater_km,mw:t.mw,tsunami_m:t.tsunami_m,shockwave:t.shockwave,fireball:t.fireball,casualties:i,meta:t.meta},[t.xs,t.lats,t.lons,t.alts,t.vs,t.wzs,t.times,t.ms])}catch(t){console.error("Simulation error:",t),self.postMessage({type:"simError",error:t.message})}});function B(a){return a*Math.PI/180}function et(a){return a*180/Math.PI}function st(a,s,e,t){const o=B(a),n=B(s),l=B(e),c=t/6371e3,u=Math.sin(o)*Math.cos(c)+Math.cos(o)*Math.sin(c)*Math.cos(l),r=Math.asin(Math.max(-1,Math.min(1,u))),m=Math.sin(l)*Math.sin(c)*Math.cos(o),M=Math.cos(c)-Math.sin(o)*Math.sin(r),h=n+Math.atan2(m,M);return[et(r),(et(h)+540)%360-180]}function ot(a){const t=[{z0:0,T0:288.15,P0:101325,L:-.0065},{z0:11e3,T0:216.65,P0:22632.1,L:0},{z0:2e4,T0:216.65,P0:5474.89,L:.001},{z0:32e3,T0:228.65,P0:868.019,L:.0028},{z0:47e3,T0:270.65,P0:110.906,L:0},{z0:51e3,T0:270.65,P0:66.9389,L:-.0028},{z0:71e3,T0:214.65,P0:3.9564,L:-.002}];if(a>86e3)return 1.225*Math.exp(-10.117647058823529)*Math.exp(-(a-86e3)/1e4);let i;for(let h=t.length-1;h>=0;h--)if(a>=t[h].z0){i=t[h];break}const{z0:o,T0:n,P0:l,L:c}=i,u=a-o;let r,m;return c===0?(r=n,m=l*Math.exp(-9.80665*u/(287.05*n))):(r=n+c*u,m=l*Math.pow(n/r,9.80665/(287.05*c))),m/(287.05*r)}function J(a,s){const e=a.vx,t=a.wz,i=a.m,o=Math.sqrt(e*e+t*t)||1e-6,n=Math.PI*(s.radius*s.radius);if(s.vacuum){const O=66743e-15,V=59722e20,D=6371e3+Math.max(0,a.z),b=O*V/(D*D);return{dxdt:e,dzdt:t,ax:0,az:-b,dmdt:0,speed:o}}const l=ot(Math.max(0,a.z));let c=s.Cd;o>15e3?c=.3:o>8e3?c=.5:c=1;const u=.5*c*l*n*o*o/Math.max(1e-9,i),r=-u*(e/o),m=6371e3,M=66743e-15,h=59722e20,w=m+Math.max(0,a.z),x=M*h/(w*w),p=-u*(t/o)-x,d={vCut:4e3,vRef:12e3,altShield:1e4,dynP0:2e5,maxRho:.5},g=P=>P<0?0:P>1?1:P,y=Math.min(l,d.maxRho);let R=(o-d.vCut)/(d.vRef-d.vCut);R=Math.pow(g(R),1.3);const T=Math.max(0,a.z),L=T/(T+d.altShield),E=.5*y*o*o,C=E/(E+d.dynP0),$=R*L*C,F=-(s.Ch*y*n*o*o)/(2*s.Q)*$;return{dxdt:e,dzdt:t,ax:r,az:p,dmdt:F,speed:o}}function nt(a,s,e){const t=J(a,e),i={x:a.x+t.dxdt*s/2,z:a.z+t.dzdt*s/2,vx:a.vx+t.ax*s/2,wz:a.wz+t.az*s/2,m:a.m+t.dmdt*s/2},o=J(i,e),n={x:a.x+o.dxdt*s/2,z:a.z+o.dzdt*s/2,vx:a.vx+o.ax*s/2,wz:a.wz+o.az*s/2,m:a.m+o.dmdt*s/2},l=J(n,e),c={x:a.x+l.dxdt*s,z:a.z+l.dzdt*s,vx:a.vx+l.ax*s,wz:a.wz+l.az*s,m:a.m+l.dmdt*s},u=J(c,e),r=a.vx+s*(t.ax+2*o.ax+2*l.ax+u.ax)/6,m=a.wz+s*(t.az+2*o.az+2*l.az+u.az)/6;return{x:a.x+s*(t.dxdt+2*o.dxdt+2*l.dxdt+u.dxdt)/6,z:a.z+s*(t.dzdt+2*o.dzdt+2*l.dzdt+u.dzdt)/6,vx:r,wz:m,m:a.m+s*(t.dmdt+2*o.dmdt+2*l.dmdt+u.dmdt)/6,speed:Math.sqrt(r*r+m*m)}}function kt(a,s,e){const t=Math.sqrt(a.vx*a.vx+a.wz*a.wz);let i=e;if(t>25e3?i=Math.min(i,5e-4):t>2e4?i=Math.min(i,.001):t>15e3?i=Math.min(i,.002):t>1e4&&(i=Math.min(i,.005)),a.z>8e4?i=Math.min(i,.01):a.z>5e4?i=Math.min(i,.005):a.z>2e4&&(i=Math.min(i,.002)),Math.abs(a.wz)>0){const o=50/Math.abs(a.wz);i=Math.min(i,o)}return Math.max(1e-6,i)}function I(a,s,e){return a+(s-a)*e}function _t(a){let e=a*.1,t=e/4184e9,i=15*Math.cbrt(t)*1.56,o=Math.sqrt(.2*e/(4*Math.PI*25e4));o=o/80;let n=Math.sqrt(.2*e/(4*Math.PI*1e5));return n=n/70,{Rfireball:i,R3b:o,R2b:n}}function Tt(a){let s={};const e=a/4184e9;let t,i,o,n,l,c,u,r,m,M,h,w,x,p=0;if(a<12e17)return p=0,s;if(a>=12e17?p=3:a>=39e16&&a<12e17?p=2:a>=65e15&&a<39e16&&(p=1),p==1)return t=10,n=t/Math.cbrt(e),h=(2.16/n**3+.584/n**2+1.8/n-.114)*100,w=1.2*Math.sqrt(h),x=4,s={windspeed:w,R:t,Ef:x},s;if(p==2)return t=10,i=80,n=t/Math.cbrt(e),h=(2.16/n**3+.584/n**2+1.8/n-.114)*100,w=1.2*Math.sqrt(h),l=i/Math.cbrt(e),c=(2.16/l**3+.584/l**2+1.8/l-.114)*100,u=1.2*Math.sqrt(c),x=5,s={windspeed:w,windspeed1:u,Ef:x,R:t,R1:i},s;if(p==3)return t=10,i=80,o=200,n=t/Math.cbrt(e),h=(2.16/n**3+.584/n**2+1.8/n-.114)*100,w=1.2*Math.sqrt(h),l=i/Math.cbrt(e),c=(2.16/l**3+.584/l**2+1.8/l-.114)*100,u=1.2*Math.sqrt(c),r=o/Math.cbrt(e),m=(2.16/r**3+.584/r**2+1.8/r-.114)*100,M=1.2*Math.sqrt(m),x=5.5,s={windspeed:w,windspeed1:u,windspeed2:M,Ef:x,R:t,R1:i,R2:o},s}function $t(a){if(typeof a.diameter!="number"||a.diameter<=0||typeof a.density!="number"||a.density<=0||typeof a.v0!="number"||a.v0<=0)throw new Error("Invalid simulation parameters: diameter, density, and v0 must be positive numbers.");const s=a.lat0,e=a.lon0,t=a.bearing,i=a.diameter,o=a.density,n=a.v0,l=a.angleDeg,c=typeof a.alt0=="number"?a.alt0:1e5,u=a.dt&&a.dt>0?a.dt:.02,r=i/2,m=4/3*Math.PI*Math.pow(r,3)*o,M={radius:r,Cd:1,Ch:.005,Q:5e7},h=1e7,w=B(Math.abs(l));let x=n*Math.cos(w),p=-n*Math.sin(w),d=0,g=c,y=m,R=0;const T=[],L=[],E=[],C=[],$=[],K=[],F=[],P=[],O=5e3,V=1e4;let D=0,b=!1,it=null,q=!1,rt=-1,lt=null;const Dt=3e-4;let j=!1,ct=null,Q=null,U=null;for(;;){if(g<=0){b=!0;break}const[Ht,Ot]=st(s,e,t,d);T.push(d),L.push(Ht),E.push(Ot),C.push(Math.max(0,g));const Y=Math.sqrt(x*x+p*p);if($.push(Y),K.push(p),F.push(R),P.push(y),!q&&y<=Dt*m){q=!0,rt=T.length-1,lt=R,y=0;break}if(g>1e6&&l<=5||g>1e8&&l<=70||g>1e9&&l<=88||g>1e10&&l!=90){j=!0,ct="ballistic_escape";break}if(D%O===0){const z=(y/m*100).toFixed(2);console.log(`[worker] step ${D} t=${R.toFixed(1)}s alt=${(g/1e3).toFixed(2)}km speed=${(Y/1e3).toFixed(2)}km/s mass=${z}%`)}const v={x:d,z:g,vx:x,wz:p,m:y};let k=kt(v,M,u);g<V&&(k=Math.min(k,.001));let f=nt(v,k,M),ft=0;const Vt=6,jt=Math.max(Y,1e-6);for(;ft<Vt;){let z=!1;f.z>v.z+Math.max(100,Math.abs(v.z)*.01)&&(z=!0);const S=Math.sqrt(f.vx*f.vx+f.wz*f.wz)/jt;if((S>1.5||S<.5)&&(z=!0),Math.sqrt(Math.pow((f.vx-v.vx)/k,2)+Math.pow((f.wz-v.wz)/k,2))>5e3&&(z=!0),(!isFinite(f.x)||!isFinite(f.z)||!isFinite(f.vx)||!isFinite(f.wz)||!isFinite(f.m))&&(z=!0),!z)break;if(k*=.3,k<1e-6){console.warn("[worker] dt underflow terminating");break}f=nt(v,k,M),ft++}if(f.z<=0){const z=v.z/(v.z-f.z),Z=I(v.x,f.x,z),S=I(v.vx,f.vx,z),W=I(v.wz,f.wz,z),Qt=Math.sqrt(S*S+W*W),[dt,pt]=st(s,e,t,Z),tt=R+k*z,Mt=I(y,Math.max(0,f.m),z);T.push(Z),L.push(dt),E.push(pt),C.push(0),$.push(Qt),K.push(W),F.push(tt),P.push(Mt),R=tt,b=!0,it=tt,y=Mt,Q=dt,U=pt;break}d=f.x,g=f.z,x=f.vx,p=f.wz,y=Math.max(0,f.m),R+=k,D++,.5*ot(Math.max(0,g))*(x*x+p*p)>h&&Math.random()<.02&&(y*=.95)}const Ft=T.length,At=new Float64Array(T).buffer,Et=new Float64Array(L).buffer,Ct=new Float64Array(E).buffer,Lt=new Float32Array(C).buffer,qt=new Float32Array($).buffer,Nt=new Float32Array(K).buffer,St=new Float64Array(F).buffer,Bt=new Float64Array(P).buffer,N=.5*m*n*n,G=$.length?$[$.length-1]:0,X=P.length?P[P.length-1]:y,A=.5*X*G*G;console.log("[worker] Energy debug:",{initialEk:N,lastSpeed:G,lastMass:X,residualEk:A,impacted:b,disintegrated:q,earlyTermination:j});const ut=_t(A);console.log("[worker] Fireball result:",ut);const Jt=Tt(A),mt=A>0?A:N,ht=1435e-8*Math.pow(mt,1/3.4),It=ht*1e3*5,Kt=mt*57e-6,Wt=(Math.log10(Kt)-5.24)/1.44;return console.log("[worker] Simulation complete: steps=",D,"impacted=",b,"disintegrated=",q),{xs:At,lats:Et,lons:Ct,alts:Lt,vs:qt,wzs:Nt,times:St,ms:Bt,crater_km:b?ht:0,mw:b?Wt:0,tsunami_m:b?It:0,shockwave:Jt,fireball:b?ut:null,meta:{impacted:b,disintegrated:q,disintegrationIndex:rt,disintegrationTime:lt,earlyTermination:j,terminationReason:ct,steps:D,impactTime:it,lastAlt:C[Ft-1],lastTime:F[F.length-1],initialEkJ:N,residualEkJ:A,energyFraction:N>0?A/N:1,initialMass:m,finalMass:X,impactLocation:b&&Q!==null&&U!==null?{lat:Q,lon:U}:null}}}})();
